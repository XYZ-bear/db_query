<script>
window.onload = function () {
    document.getElementById("json_code").value = JSON.stringify({
        "problems": 123, "sfsf": "sf", "fsf": { "sfsf": "sf" }, "fsfddd": [{}]
    });
    run();
}

function isInteger(n) {
    return parseInt(n) == parseFloat(n)
}
function isFloat(n) {
    return parseInt(n) < parseFloat(n)
}

function tab_len() {
    var len = document.getElementById("tab_len").value;
    var str = "";
    for (var i = 0; i < len; i++) {
        str += " ";
    }
    return str;
}

function add_tab(c_node, blob) {
    for (var i = 0; i < blob; i++) {
        c_node.value += tab_len();
    }
}

var int_type = "int";
var float_type = "float";
var bool_type = "bool";
var vec_type = "vector";
var str_type = "string";

function pares(c_node, json, blob) {
    blob += 1;
    for (var p in json) {//遍历json对象的每个key/value对,p为key
        if (Array.isArray(json[p])) {
            if (json[p].length > 0) {
                if (typeof json[p][0] == 'object') {
                    //c_node.value += "\n";
                    add_tab(c_node, blob);
                    c_node.value += "Json(" + p + "_t){\n";
                    pares(c_node, json[p][0], blob);
                    add_tab(c_node, blob);
                    c_node.value += "};\n";
                    add_tab(c_node, blob);
                    c_node.value += vec_type + "<" + p + "_t> N(" + p + ");\n";
                }
                else {
                    add_tab(c_node, blob);
                    c_node.value += vec_type + "<";
                    if (typeof json[p][0] == "string") {
                        c_node.value += str_type;
                    }
                    else if (isInteger(json[p]))
                        c_node.value += int_type;
                    else if (isFloat(json[p]))
                        c_node.value += float_type;
                    else if (typeof json[p] == "boolean")
                        c_node.value += bool_type;
                    else
                        c_node.value += (typeof json[p]);// + JSON.stringify(json[p]) + "\n");
                    c_node.value += "> N(" + p + ")" + ";\n"
                }
            }
            else {
                add_tab(c_node, blob);
                c_node.value += (str_type + " N(" + p + ")" + ";\n");
            }

        }
        else if (typeof json[p] == 'object') {
            add_tab(c_node, blob);
            c_node.value += "Json(" + p + "_t){\n";
            pares(c_node, json[p], blob);
            add_tab(c_node, blob);
            c_node.value += "};\n";
            add_tab(c_node, blob);
            c_node.value += p + "_t N(" + p + ");\n";
        }
        else {
            //c_node.value += "\n";
            add_tab(c_node, blob);
            if (typeof json[p] == "string") {
                c_node.value += (str_type + " N(" + p + ")" + ";\n");
            }
            else if (isInteger(json[p]))
                c_node.value += (int_type + " N(" + p + ")" + ";\n");
            else if (isFloat(json[p]))
                c_node.value += (float_type + " N(" + p + ")" + ";\n");
            else if (typeof json[p] == "boolean")
                c_node.value += (bool_type + " N(" + p + ")" + ";\n");
            else
                c_node.value += (typeof json[p] + " N(" + p + ")" + ";\n");// + JSON.stringify(json[p]) + "\n");
        }
    }
}

function add_tab2() {
    return tab_len();
}

var pre_define = "";
function pares2(c_node, json, blob) {
    var ele_define = "";
    for (var p in json) {//遍历json对象的每个key/value对,p为key
        if (Array.isArray(json[p])) {
            if (json[p].length > 0) {
                if (typeof json[p][0] == 'object') {
                    var str = "";
                    str += "Json(" + p + "_t){\npublic:\n";
                    str += pares2(c_node, json[p][0], blob);
                    str += "};\n\n";
                    ele_define += add_tab2();
                    ele_define += vec_type + "<" + p + "_t> N(" + p + ");\n";
                    pre_define += (str);
                }
                else {
                    ele_define += add_tab2();
                    ele_define += vec_type + "<";
                    if (typeof json[p][0] == "string")
                        ele_define += str_type;
                    else if (isInteger(json[p]))
                        ele_define += int_type;
                    else if (isFloat(json[p]))
                        ele_define += float_type;
                    else if (typeof json[p] == "boolean")
                        ele_define += bool_type;
                    else
                        ele_define += (typeof json[p]);// + JSON.stringify(json[p]) + "\n");
                    ele_define += "> N(" + p + ")" + ";\n"
                }
            }
            else {
                ele_define += add_tab2();
                ele_define += (str_type + " N(" + p + ")" + ";\n");
            }

        }
        else if (typeof json[p] == 'object') {
            var str = "";
            str += "Json(" + p + "_t){\npublic:\n";
            str += pares2(c_node, json[p], blob);
            str += "};\n\n";
            ele_define += add_tab2();
            ele_define += p + "_t N(" + p + ");\n";
            pre_define += (str);
        }
        else {
            ele_define += add_tab2();
            if (typeof json[p] == "string") {
                ele_define += (str_type + " N(" + p + ")" + ";\n");
            }
            else if (isInteger(json[p]))
                ele_define += (int_type + " N(" + p + ")" + ";\n");
            else if (isFloat(json[p]))
                ele_define += (float_type + " N(" + p + ")" + ";\n");
            else if (typeof json[p] == "boolean")
                ele_define += (bool_type + " N(" + p + ")" + ";\n");
            else
                ele_define += (typeof json[p] + " N(" + p + ")" + ";\n");// + JSON.stringify(json[p]) + "\n");
        }
    }
    return ele_define;
}

function add_tab3(blob) {
    var str = "";
    for (var i = 0; i < blob; i++) {
        str += tab_len();
    }
    return str;
}

function do_stringfy(json, blob) {
    blob++;
    var ele_define = "";
    var str = "";
    for (var p in json) {//遍历json对象的每个key/value对,p为key
        if (Array.isArray(json[p])) {
            str += add_tab3(blob);
            str += "\"" + p + "\":[";

            if (json[p].length > 0) {
                for (j = 0; j < json[p].length; j++) {
                    if (typeof json[p][j] == 'object' && JSON.stringify(json[p][j]) != "{}" && json[p][j]!=null) {
                        if (json[p] != null) {
                            str += "{\n";
                            str += do_stringfy(json[p][j], blob);
                            str = str.substr(0, str.length - 2);
                            str += "\n" + add_tab3(blob) + "},";
                        }
                        else {
                            str += add_tab3(blob);
                            str += "\"" + p + "\":" + json[p] + ",\n";
                        }
                    }
                    else if (JSON.stringify(json[p][j]) == "{}") {
                        str += "{}\n";
                    }
                    else {
                        if (typeof json[p][j] == "string") {
                            str += "\"" + json[p][j] + "\",";
                        }
                        else
                            str += json[p][j] + ",";
                    }
                }
                str = str.substr(0, str.length - 1);
                str += "],\n";
            }
            else {
                str += "],\n";
            }
        }
        else if (typeof json[p] == 'object') {
            if (json[p] != null) {
                str += add_tab3(blob);
                str += "\"" + p + "\":\n";
                str += add_tab3(blob) + "{\n";
                str += do_stringfy(json[p], blob);
                str = str.substr(0, str.length - 2);
                str += "\n" + add_tab3(blob) + "},\n";
            }
            else {
                str += add_tab3(blob);
                str += "\"" + p + "\":" + json[p] + ",\n";
            }
        }
        else {
            str += add_tab3(blob);
            if (typeof json[p] == "string") {
                str += "\"" + p + "\":\"" + json[p] + "\",\n";
            }
            else
                str += "\"" + p + "\":" + json[p] + ",\n";
        }
    }

    return str;
}

function stringfy(json) {
    var str = "{\n";
    str += do_stringfy(json, 0);
    str = str.substr(0, str.length - 2);
    return str + "\n}";
}

function run() {
    int_type = document.getElementById("int_type").value;
    float_type = document.getElementById("float_type").value;
    bool_type = document.getElementById("bool_type").value;
    vec_type = document.getElementById("vec_type").value;
    str_type = document.getElementById("str_type").value;

    var class_name = document.getElementById("class_name").value;
    var json_code_node = document.getElementById("json_code");
    var c_code_node = document.getElementById("c_code");
    if (json_code_node.value.length > 0) {
        c_code_node.value = "";
        pre_define = "";
        try {
            myJson = JSON.parse(json_code_node.value);// {"basic":{"cid":"1","location":"2","lon":"3","lat":"4","ca":0,"parent_city":"6","admin_area":"7","cnty":"8","tz":"9"},"basics":[1,2,3]};

            json_code_node.value = stringfy(myJson);
            var is_recursive = document.getElementById("r1").checked;
            if (!is_recursive) {
                c_code_node.value = "Json(" + class_name + ")\n{\npublic:\n";
                var str = "Json(" + class_name + ")\n{\npublic:\n";
                var blob = 0;
                str += pares2(c_code_node, myJson, blob);
                c_code_node.value += "};";
                pre_define += str;
                pre_define += "};";
                c_code_node.value = pre_define;
            }
            else {
                c_code_node.value = "Json(" + class_name + ")\n{\npublic:\n";
                var blob = 0;
                pares(c_code_node, myJson, blob);
                c_code_node.value += "};";
            }

        } catch (e) {
            c_code_node.value = "json format error";//'error：' + str + '!!!' + e;
            return false;
        }
    }
}
</script>


<!DOCTYPE html>
<html>

<head>
	<title>登陆.html</title>
</head>

<body>
	<form name="user" action="#" method="get" oninput ="run()">
		<table align="center">
			<tr>
				<td>类名：</td>
				<td>
					<input type="text" name="class_name" id="class_name" value="Test"/>
                </td>
          </tr>
            <tr>
				<td>整型：</td>
				<td>
					<input type="text" name="int_type" id="int_type" value="int"/>
                </td>
          </tr>
         <tr>
				<td>浮点型：</td>
				<td>
					<input type="text" name="float_type" id="float_type" value="double"/>
                </td>
          </tr>
          <tr>
				<td>bool型：</td>
				<td>
					<input type="text" name="bool_type" id="bool_type" value="bool"/>
                </td>
          </tr>
          <tr>
				<td>数组型：</td>
				<td>
					<input type="text" name="vec_type" id="vec_type" value="vector"/>
                </td>
          </tr>
          <tr>
				<td>字符串型：</td>
				<td>
					<input type="text" name="str_type" id="str_type" value="string"/>
                </td>
          </tr>
          <tr>
				<td>制表符长度：</td>
				<td>
					<input type="text" name="tab_len" id="tab_len" value="4"/>
                </td>
          </tr>
          <tr>
				<td>递归定义：</td>
				<td>
					<label><input name="Recursive" id = "r1" type="radio" value="" checked="true"/>是 </label>
                    <label><input name="Recursive" id = "r2" type="radio" value=""/>否 </label>
                </td>
          </tr>
          <tr>
				<td>json</td>
				<td>c++</td>
          </tr>
          <tr>
             <td>
                <textarea rows="55" cols="70" name="json_code" id="json_code"></textarea>
            </td>
             <td>
                <textarea rows="55" cols="70" name="c_code"" id="c_code" style="pre"></textarea>
            </td>
          </tr>
       </table>
    </form>
  </body>
</html>